# .github/workflows/spanish-learning-automation.yml
name: 스페인어 학습 자료 자동 수집

on:
  schedule:
    # 매일 UTC 23:00 (한국시간 오전 8시)에 실행
    - cron: "0 23 * * 1-5" # 평일만 실행
  workflow_dispatch: # 수동 실행 가능

env:
  NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
  NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}

jobs:
  collect-learning-materials:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install requests beautifulsoup4 feedparser python-dateutil lxml

      - name: Calculate learning phase and schedule
        id: phase
        run: |
          python3 << 'EOF'
          import os
          from datetime import datetime, timedelta

          # 학습 시작일 (2025-07-01)
          start_date = datetime(2025, 7, 1)
          current_date = datetime.now()

          # 주차 계산
          week_num = (current_date - start_date).days // 7 + 1
          weekday = current_date.weekday()  # 0=월요일

          # 독해 소스 결정
          if week_num <= 2:
              reading_source = "20minutos"
              reading_url = "https://www.20minutos.es/"
              reading_difficulty = "B2"
          elif week_num <= 4:
              reading_source = "El País 단신"
              reading_url = "https://elpais.com/"
              reading_difficulty = "B2"
          else:
              reading_source = "El País 사설"
              reading_url = "https://elpais.com/opinion/"
              reading_difficulty = "C1"
              
          # 팟캐스트 일정 (RSS 피드와 Apple Podcasts 링크)
          podcast_schedule = {
              0: {
                  "name": "Hoy Hablamos",
                  "rss": "https://feeds.feedburner.com/hoyhablamos",
                  "apple_base": "https://podcasts.apple.com/kr/podcast/hoy-hablamos-podcast-diario-para-aprender-español-learn/id1201483158",
                  "region": "스페인",
                  "backup_url": "https://www.hoyhablamos.com/"
              },
              1: {
                  "name": "Radio Ambulante", 
                  "rss": "https://feeds.npr.org/510311/podcast.xml",
                  "apple_base": "https://podcasts.apple.com/kr/podcast/radio-ambulante/id527614348",
                  "region": "중남미",
                  "backup_url": "https://radioambulante.org/"
              },
              2: {
                  "name": "Advanced Spanish",
                  "rss": "https://feeds.buzzsprout.com/1829091.rss", 
                  "apple_base": "https://podcasts.apple.com/kr/podcast/advanced-spanish-podcast-español-avanzado/id1632291264",
                  "region": "스페인",
                  "backup_url": "https://www.spanishlanguagecoach.com/podcast/"
              },
              3: {
                  "name": "Radio Ambulante",
                  "rss": "https://feeds.npr.org/510311/podcast.xml",
                  "apple_base": "https://podcasts.apple.com/kr/podcast/radio-ambulante/id527614348", 
                  "region": "중남미",
                  "backup_url": "https://radioambulante.org/"
              },
              4: {
                  "name": "DELE Podcast",
                  "rss": "https://anchor.fm/s/f4f4a4f0/podcast/rss",
                  "apple_base": "https://podcasts.apple.com/us/podcast/examen-dele/id1705001626",
                  "region": "스페인", 
                  "backup_url": "https://anchor.fm/examen-dele"
              }
          }

          podcast_info = podcast_schedule.get(weekday, podcast_schedule[0])

          # GitHub Actions 환경변수로 출력
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"week_num={week_num}\n")
              f.write(f"reading_source={reading_source}\n")
              f.write(f"reading_url={reading_url}\n")
              f.write(f"reading_difficulty={reading_difficulty}\n")
              f.write(f"podcast_name={podcast_info['name']}\n")
              f.write(f"podcast_rss={podcast_info['rss']}\n")
              f.write(f"podcast_apple_base={podcast_info['apple_base']}\n")
              f.write(f"podcast_region={podcast_info['region']}\n")
              f.write(f"podcast_backup={podcast_info['backup_url']}\n")
              f.write(f"date={current_date.strftime('%Y-%m-%d')}\n")
              f.write(f"weekday_name={['월요일', '화요일', '수요일', '목요일', '금요일', '토요일', '일요일'][weekday]}\n")
          EOF

      - name: Collect articles and podcast episodes with detailed info
        id: materials
        run: |
          python3 << 'EOF'
          import os
          import requests
          import feedparser
          from datetime import datetime
          import re
          from bs4 import BeautifulSoup
          from urllib.parse import urljoin

          def extract_category_from_summary(summary):
              keywords = {
                  '정치': ['gobierno', 'política', 'elecciones', 'parlamento', 'ministro', 'rey'],
                  '경제': ['economía', 'banco', 'euro', 'empleo', 'crisis', 'mercado', 'dinero', 'trabajo'],
                  '사회': ['sociedad', 'educación', 'sanidad', 'vivienda', 'familia', 'salud'],
                  '스포츠': ['fútbol', 'Real Madrid', 'Barcelona', 'Liga', 'deporte', 'partido'],
                  '기술': ['tecnología', 'internet', 'móvil', 'digital', 'app', 'inteligencia'],
                  '문화': ['cultura', 'arte', 'música', 'teatro', 'festival', 'libro']
              }
              
              summary_lower = summary.lower()
              for category, words in keywords.items():
                  if any(word in summary_lower for word in words):
                      return category
              return '일반'

          def extract_episode_number(title):
              patterns = [
                  r'Ep\.?\s*(\d+)',
                  r'Episode\s*(\d+)',
                  r'#(\d+)',
                  r'(\d{3,4})'
              ]
              
              for pattern in patterns:
                  match = re.search(pattern, title, re.IGNORECASE)
                  if match:
                      return match.group(1)
              return None

          def extract_duration_from_feed(entry):
              # iTunes 듀레이션 먼저 확인
              if hasattr(entry, 'itunes_duration'):
                  duration = entry.itunes_duration
                  # 초 단위인 경우 분:초로 변환
                  if duration.isdigit():
                      total_seconds = int(duration)
                      minutes = total_seconds // 60
                      seconds = total_seconds % 60
                      return f"{minutes}:{seconds:02d}"
                  return duration
              
              # 요약에서 재생시간 추출 시도
              summary = entry.get('summary', '') + entry.get('description', '')
              duration_patterns = [
                  r'(\d+)\s*min',
                  r'(\d+)\s*분',
                  r'(\d+):(\d+)',
                  r'Duration:\s*(\d+)'
              ]
              
              for pattern in duration_patterns:
                  match = re.search(pattern, summary)
                  if match:
                      if ':' in pattern:
                          return f"{match.group(1)}:{match.group(2)}"
                      else:
                          return f"{match.group(1)}분"
              
              return "15-25분"

          def extract_topic_keywords(title, summary=""):
              content = (title + " " + summary).lower()
              
              topic_keywords = {
                  '문법': ['gramática', 'verbos', 'subjuntivo', 'pretérito', 'sintaxis'],
                  '문화': ['cultura', 'tradición', 'costumbres', 'historia', 'arte'],
                  '요리': ['cocina', 'comida', 'receta', 'gastronomía', 'plato'],
                  '여행': ['viajes', 'turismo', 'ciudades', 'lugares', 'destinos'],
                  '직업': ['trabajo', 'empleo', 'profesión', 'carrera', 'oficina'],
                  '가족': ['familia', 'padres', 'hijos', 'matrimonio', 'casa'],
                  '기술': ['tecnología', 'internet', 'móviles', 'digital', 'aplicaciones'],
                  '정치': ['política', 'gobierno', 'elecciones', 'democracia'],
                  '경제': ['economía', 'dinero', 'banco', 'trabajo', 'crisis', 'preferentes', 'ahorros'],
                  '사회': ['sociedad', 'gente', 'problemas', 'cambios', 'vida'],
                  '건강': ['salud', 'medicina', 'hospital', 'enfermedad', 'médico'],
                  '교육': ['educación', 'estudiantes', 'universidad', 'aprender']
              }
              
              for topic, keywords in topic_keywords.items():
                  if any(keyword in content for keyword in keywords):
                      return topic
              return '일반 주제'

          def get_key_expressions(title, summary=""):
              content = title + " " + summary
              
              # 스페인어 핵심 표현과 한국어 뜻 사전
              expression_dict = {
                  # 일반적인 관용 표현
                  'caer en la trampa': '함정에 빠지다',
                  'perder los ahorros': '저축을 잃다',
                  'hacer caso': '신경 쓰다, 주의를 기울이다',
                  'darse cuenta': '깨닫다, 알아차리다',
                  'tener en cuenta': '고려하다, 염두에 두다',
                  'por si acaso': '혹시 모르니까',
                  'de vez en cuando': '가끔',
                  'estar de acuerdo': '동의하다',
                  'tener razón': '옳다, 맞다',
                  'hacer falta': '필요하다',
                  'echar de menos': '그리워하다',
                  'llevarse bien': '잘 지내다',
                  'ponerse en contacto': '연락하다',
                  'tomar el pelo': '놀리다, 농담하다',
                  'meter la pata': '실수하다',
                  'quedarse sin palabras': '말문이 막히다',
                  'estar hasta las narices': '지긋지긋하다',
                  'dar igual': '상관없다',
                  'costar trabajo': '힘들다',
                  'hacer gracia': '재미있다',
                  'dar la lata': '귀찮게 하다',
                  'perder el tiempo': '시간을 낭비하다',
                  'tener suerte': '운이 좋다',
                  'estar harto': '지긋지긋하다',
                  'dar miedo': '무섭다',
                  'tener ganas': '하고 싶다',
                  'hacer cola': '줄을 서다',
                  'estar de moda': '유행하다',
                  'salir adelante': '앞으로 나아가다',
                  'llevarse un susto': '놀라다',
                  'tener prisa': '급하다',
                  'hacer daño': '해를 끼치다',
                  'dar las gracias': '감사하다',
                  'tener cuidado': '조심하다',
                  'estar de broma': '농담하다',
                  'dar pena': '안타깝다',
                  'tener éxito': '성공하다',
                  'hacer el ridículo': '웃음거리가 되다',
                  'dar vergüenza': '부끄럽다',
                  'tener hambre': '배고프다',
                  'estar de viaje': '여행 중이다',
                  'dar la razón': '동의하다',
                  'tener sed': '목마르다',
                  'estar de vuelta': '돌아오다',
                  'tener frío': '춥다',
                  'estar de pie': '서 있다',
                  'hacer ruido': '소음을 내다',
                  'dar calor': '따뜻하다',
                  'tener sueño': '졸리다',
                  'estar de mal humor': '기분이 나쁘다',
                  'hacer ejercicio': '운동하다',
                  'dar asco': '역겹다',
                  
                  # 연결어 표현
                  'al fin y al cabo': '결국',
                  'a fin de cuentas': '결국',
                  'en resumidas cuentas': '요약하면',
                  'por lo tanto': '따라서',
                  'sin embargo': '그러나',
                  'por consiguiente': '그 결과',
                  'a pesar de': '~에도 불구하고',
                  'con tal de que': '~하는 한',
                  'siempre y cuando': '~하는 한',
                  'a no ser que': '~하지 않는 한',
                  'con el fin de': '~하기 위해',
                  'en cuanto a': '~에 관해서',
                  'en lo que respecta': '~에 관해서',
                  'por lo que respecta': '~에 관해서',
                  'en lo que se refiere': '~에 관해서',
                  'por otro lado': '반면에',
                  'de todos modos': '어쨌든',
                  'en cualquier caso': '어떤 경우든',
                  'de todas formas': '어쨌든',
                  'en todo caso': '어떤 경우든',
                  
                  # 구어체 표현
                  'ponerse las pilas': '정신차리다',
                  'tirar la casa por la ventana': '돈을 물 쓰듯 하다',
                  'estar en las nubes': '딴 생각에 빠져있다',
                  'costar un ojo de la cara': '매우 비싸다',
                  'ser pan comido': '식은 죽 먹기다',
                  'llover a cántaros': '비가 억수로 내리다',
                  'ser una ganga': '싸게 사다',
                  'estar como una cabra': '미쳤다',
                  'estar en babia': '딴 생각에 빠져있다',
                  'ser un hueso duro de roer': '만만치 않다',
                  
                  # 정치/사회 표현
                  'apoyar la propuesta': '제안을 지지하다',
                  'buscar un entendimiento': '합의를 찾다',
                  'reflexionar sobre': '~에 대해 숙고하다',
                  'desdeñar la oferta': '제안을 무시하다',
                  'abrir el diálogo': '대화를 시작하다',
                  'tender puentes': '가교를 놓다',
                  'romper el consenso': '합의를 깨뜨리다',
                  'fortalecer la democracia': '민주주의를 강화하다',
                  'garantizar la estabilidad': '안정을 보장하다',
                  'promover el cambio': '변화를 촉진하다',
                  
                  # 경제/금융 표현
                  'productos financieros': '금융 상품',
                  'preferentes': '우선주',
                  'crisis económica': '경제 위기',
                  'mercado financiero': '금융 시장',
                  'inversión segura': '안전한 투자',
                  'riesgo elevado': '높은 위험',
                  'rentabilidad': '수익성',
                  'entidades bancarias': '은행 기관',
                  'supervisión financiera': '금융 감독',
                  'protección al consumidor': '소비자 보호'
              }
              
              # 컨텐츠에서 표현 찾기
              found_expressions = []
              content_lower = content.lower()
              
              for expression, meaning in expression_dict.items():
                  if expression.lower() in content_lower:
                      found_expressions.append(f"{expression} ({meaning})")
              
              # 추가적으로 동사 + 명사 조합이나 중요한 구문 찾기
              important_patterns = [
                  r'\b(se abre a \w+)\b',  # "se abre a reflexionar" 같은 패턴
                  r'\b(no buscar \w+)\b',   # "no buscar un entendimiento" 같은 패턴
                  r'\b(desdeñar \w+)\b',    # "desdeñar la oferta" 같은 패턴
                  r'\b(tender \w+)\b',      # "tender puentes" 같은 패턴
                  r'\b(fortalecer \w+)\b',  # "fortalecer la democracia" 같은 패턴
              ]
              
              for pattern in important_patterns:
                  matches = re.findall(pattern, content, re.IGNORECASE)
                  for match in matches:
                      if match not in [expr.split(' (')[0] for expr in found_expressions]:
                          # 간단한 번역 추가
                          if 'se abre a' in match:
                              found_expressions.append(f"{match} (~에 열려있다)")
                          elif 'no buscar' in match:
                              found_expressions.append(f"{match} (~을 찾지 않다)")
                          elif 'desdeñar' in match:
                              found_expressions.append(f"{match} (~을 무시하다)")
                          elif 'tender' in match:
                              found_expressions.append(f"{match} (~을 내밀다)")
                          elif 'fortalecer' in match:
                              found_expressions.append(f"{match} (~을 강화하다)")
              
              # 중복 제거 및 최대 2개 반환
              unique_expressions = list(dict.fromkeys(found_expressions))
              return unique_expressions[:2]

          def create_detailed_memo(content_type, data, weekday_name):
              if content_type == "article":
                  category = data.get('category', '일반')
                  expressions = data.get('expressions', [])
                  
                  expressions_text = ""
                  if expressions:
                      expr_list = ", ".join(expressions[:2])
                      expressions_text = f"💡 핵심 표현: {expr_list} "
                  
                  return (f"📰 {category} 분야 기사 "
                         f"📅 발행: {data.get('published', '오늘')} "
                         f"🎯 학습목표: 15분 독해, 어휘 5개 정리 "
                         f"{expressions_text}"
                         f"📝 권장: 모르는 단어는 노트에 정리하며 읽기")

              elif content_type == "podcast":
                  podcast_name = data.get('podcast_name', '')
                  duration = data.get('duration', '15-25분')
                  topic = data.get('topic', '일반 주제')
                  expressions = data.get('expressions', [])
                  episode_num = data.get('episode_number', '')
                  
                  # 주제에 따른 학습목표 설정
                  learning_goals = {
                      '경제': '금융 어휘',
                      '정치': '정치 용어',
                      '문화': '문화 표현',
                      '사회': '사회 이슈 어휘',
                      '교육': '교육 관련 어휘',
                      '건강': '의료 용어',
                      '기술': '기술 용어',
                      '문법': '문법 구조'
                  }
                  goal = learning_goals.get(topic, '핵심 어휘')
                  
                  # 재생시간에 따른 청취 계획 설정
                  if ':' in duration:
                      try:
                          minutes, seconds = duration.split(':')
                          total_minutes = int(minutes)
                          if total_minutes > 30:
                              listen_plan = f"(30분 청취 목표)"
                          elif total_minutes > 20:
                              listen_plan = f"(전체 {duration} 청취)"
                          else:
                              listen_plan = f"(전체 {duration} 청취)"
                      except:
                          listen_plan = "(25분 청취 목표)"
                  else:
                      listen_plan = "(25분 청취 목표)"
                  
                  expressions_text = ""
                  if expressions:
                      # 표현들을 쉼표로 구분하여 표시 (한글 뜻 포함)
                      expr_list = ", ".join(expressions[:2])
                      expressions_text = f"💡 핵심 표현: {expr_list} "
                  
                  return (f"🎧 {podcast_name} Ep.{episode_num} - {weekday_name} 스페인 팟캐스트 "
                         f"⏱️ 재생시간: {duration} {listen_plan} "
                         f"🎯 학습목표: {goal} 5개 정리 "
                         f"🌍 주제: {topic} "
                         f"{expressions_text}"
                         f"📝 권장: 핵심 어휘에 집중하여 청취")

          # 기사 수집
          reading_source = "${{ steps.phase.outputs.reading_source }}"
          article_data = None

          try:
              if reading_source == "20minutos":
                  feed_url = "https://www.20minutos.es/rss/"
              elif "El País" in reading_source:
                  if "사설" in reading_source:
                      feed_url = "https://feeds.elpais.com/mrss-s/pages/ep/site/elpais.com/section/opinion"
                  else:
                      feed_url = "https://feeds.elpais.com/mrss-s/pages/ep/site/elpais.com/portada"
              
              feed = feedparser.parse(feed_url)
              if feed.entries:
                  latest = feed.entries[0]
                  summary = latest.get('summary', '')
                  # 제목 정리 (escape sequence 제거)
                  clean_title = latest.title.replace('&quot;', '"').replace('&amp;', '&').replace('&lt;', '<').replace('&gt;', '>')
                  # 기사에서도 핵심 표현 추출
                  expressions = get_key_expressions(clean_title, summary)
                  article_data = {
                      'title': clean_title,
                      'url': latest.link,
                      'published': latest.get('published', ''),
                      'category': extract_category_from_summary(summary),
                      'preview': summary,
                      'expressions': expressions
                  }
          except Exception as e:
              print(f"기사 수집 오류: {e}")

          # 팟캐스트 에피소드 수집
          podcast_rss = "${{ steps.phase.outputs.podcast_rss }}"
          podcast_name = "${{ steps.phase.outputs.podcast_name }}"
          weekday_name = "${{ steps.phase.outputs.weekday_name }}"
          podcast_data = None

          try:
              feed = feedparser.parse(podcast_rss)
              if feed.entries:
                  latest = feed.entries[0]
                  episode_number = extract_episode_number(latest.title)
                  duration = extract_duration_from_feed(latest)
                  topic = extract_topic_keywords(latest.title, latest.get('summary', ''))
                  expressions = get_key_expressions(latest.title, latest.get('summary', ''))
                  
                  apple_base = "${{ steps.phase.outputs.podcast_apple_base }}"
                  episode_link = latest.link
                  
                  # Apple Podcasts 링크 생성 개선
                  if 'npr.org' in episode_link or 'radioambulante' in episode_link:
                      # Radio Ambulante의 경우 기본 링크 사용
                      apple_episode_link = apple_base
                  else:
                      # 다른 팟캐스트는 에피소드 ID 추출 시도
                      episode_id_match = re.search(r'/(\d+)', episode_link)
                      if episode_id_match:
                          apple_episode_link = f"{apple_base}?i={episode_id_match.group(1)}"
                      else:
                          apple_episode_link = apple_base
                  
                  # 제목 정리 (escape sequence 제거)
                  clean_title = latest.title.replace('&quot;', '"').replace('&amp;', '&').replace('&lt;', '<').replace('&gt;', '>')
                  
                  podcast_data = {
                      'podcast_name': podcast_name,
                      'title': clean_title,
                      'url': apple_episode_link,
                      'original_url': episode_link,
                      'duration': duration,
                      'topic': topic,
                      'expressions': expressions,
                      'episode_number': episode_number or 'Latest',
                      'published': latest.get('published', ''),
                      'region': "${{ steps.phase.outputs.podcast_region }}"
                  }
          except Exception as e:
              print(f"팟캐스트 수집 오류: {e}")
              podcast_data = {
                  'podcast_name': podcast_name,
                  'title': f"{podcast_name} - 최신 에피소드",
                  'url': "${{ steps.phase.outputs.podcast_apple_base }}",
                  'duration': "15-25분",
                  'topic': "일반 주제",
                  'expressions': [],
                  'episode_number': 'Latest',
                  'region': "${{ steps.phase.outputs.podcast_region }}"
              }

          # 결과 출력
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              if article_data:
                  # 따옴표와 특수문자 이스케이프 처리
                  article_title_clean = article_data['title'].replace('\n', ' ').replace('\r', ' ').replace('"', '\\"').replace("'", "\\'")
                  article_memo_clean = create_detailed_memo('article', article_data, weekday_name)
                  f.write(f"article_title={article_title_clean}\n")
                  f.write(f"article_url={article_data['url']}\n")
                  f.write(f"article_memo={article_memo_clean}\n")
              
              if podcast_data:
                  # 따옴표와 특수문자 이스케이프 처리
                  podcast_title_clean = podcast_data['title'].replace('\n', ' ').replace('\r', ' ').replace('"', '\\"').replace("'", "\\'")
                  podcast_memo_clean = create_detailed_memo('podcast', podcast_data, weekday_name)
                  f.write(f"podcast_title={podcast_title_clean}\n")
                  f.write(f"podcast_url={podcast_data['url']}\n")
                  f.write(f"podcast_memo={podcast_memo_clean}\n")
                  f.write(f"episode_number={podcast_data['episode_number']}\n")
          EOF

      - name: Add materials to Notion with detailed information
        run: |
          python3 << 'EOF'
          import os
          import requests
          import json
          from datetime import datetime

          notion_token = os.environ['NOTION_TOKEN']
          database_id = os.environ['NOTION_DATABASE_ID']

          headers = {
              "Authorization": f"Bearer {notion_token}",
              "Notion-Version": "2022-06-28", 
              "Content-Type": "application/json"
          }

          today = "${{ steps.phase.outputs.date }}"

          # 독해 자료 추가
          article_title = "${{ steps.materials.outputs.article_title }}"
          article_url = "${{ steps.materials.outputs.article_url }}"
          article_memo = "${{ steps.materials.outputs.article_memo }}"

          if article_title and article_url:
              reading_payload = {
                  "parent": {"database_id": database_id},
                  "properties": {
                      "내용": {"title": [{"text": {"content": f"[{today}] {article_title}"}}]},
                      "URL": {"url": article_url},
                      "날짜": {"date": {"start": today}},
                      "지역": {"select": {"name": "스페인"}},
                      "난이도": {"select": {"name": "${{ steps.phase.outputs.reading_difficulty }}"}},
                      "자료 유형": {"select": {"name": "기사/뉴스"}},
                      "학습 영역": {"select": {"name": "독해"}},
                      "메모": {"rich_text": [{"text": {"content": article_memo}}]}
                  }
              }
              
              try:
                  response = requests.post(
                      "https://api.notion.com/v1/pages",
                      headers=headers,
                      json=reading_payload
                  )
                  if response.status_code == 200:
                      print(f"✅ 독해 자료 추가 성공: {article_title}")
                  else:
                      print(f"❌ 독해 자료 추가 실패: {response.text}")
              except Exception as e:
                  print(f"독해 자료 전송 오류: {e}")

          # 청해 자료 추가
          podcast_title = "${{ steps.materials.outputs.podcast_title }}"
          podcast_url = "${{ steps.materials.outputs.podcast_url }}"
          podcast_memo = "${{ steps.materials.outputs.podcast_memo }}"
          episode_number = "${{ steps.materials.outputs.episode_number }}"

          display_title = f"${{ steps.phase.outputs.podcast_name }} Ep.{episode_number}"

          podcast_payload = {
              "parent": {"database_id": database_id},
              "properties": {
                  "내용": {"title": [{"text": {"content": f"[{today}] {display_title}"}}]},
                  "URL": {"url": podcast_url},
                  "날짜": {"date": {"start": today}},
                  "지역": {"select": {"name": "${{ steps.phase.outputs.podcast_region }}"}},
                  "난이도": {"select": {"name": "C1"}},
                  "자료 유형": {"select": {"name": "팟캐스트"}},
                  "학습 영역": {"select": {"name": "청해"}},
                  "메모": {"rich_text": [{"text": {"content": podcast_memo}}]}
              }
          }

          try:
              response = requests.post(
                  "https://api.notion.com/v1/pages",
                  headers=headers,
                  json=podcast_payload
              )
              if response.status_code == 200:
                  print(f"✅ 청해 자료 추가 성공: {display_title}")
              else:
                  print(f"❌ 청해 자료 추가 실패: {response.text}")
          except Exception as e:
              print(f"청해 자료 전송 오류: {e}")
          EOF

      - name: Send detailed notification
        if: success()
        run: |
          echo "🎉 ${{ steps.phase.outputs.date }} (${{ steps.phase.outputs.weekday_name }}) 스페인어 학습 자료 자동 수집 완료!"
          echo ""
          echo "📖 독해 자료:"
          echo "   제목: ${{ steps.materials.outputs.article_title }}"
          echo "   출처: ${{ steps.phase.outputs.reading_source }}"
          echo "   난이도: ${{ steps.phase.outputs.reading_difficulty }}"
          echo ""
          echo "🎧 청해 자료:"
          echo "   제목: ${{ steps.phase.outputs.podcast_name }} Ep.${{ steps.materials.outputs.episode_number }}"
          echo "   지역: ${{ steps.phase.outputs.podcast_region }}"
          echo "   링크: Apple Podcasts 앱에서 재생 가능"
          echo ""
          echo "📅 학습 주차: ${{ steps.phase.outputs.week_num }}주차"
          echo "💡 팁: 팟캐스트는 Apple Podcasts 앱을 통해 접속하시면 원활하게 재생됩니다!"
