#!/usr/bin/env python3
"""
ê°œì„ ëœ ìŠ¤í˜ì¸ì–´ í•™ìŠµ ìë£Œ ìë™í™” ì‹œìŠ¤í…œ
- ì •í™•í•œ ê¸°ì‚¬ ë§í¬ ì¶”ì¶œ
- íŠ¹ì • íŒŸìºìŠ¤íŠ¸ ì—í”¼ì†Œë“œ ì œëª© ë° ë§í¬ ì œê³µ
"""

import requests
import feedparser
import json
import re
from datetime import datetime
from bs4 import BeautifulSoup
from urllib.parse import urljoin

class ImprovedSpanishAutomation:
    def __init__(self):
        self.notion_token = os.getenv('NOTION_TOKEN')
        self.database_id = os.getenv('NOTION_DATABASE_ID')
        self.headers = {
            "Authorization": f"Bearer {self.notion_token}",
            "Notion-Version": "2022-06-28",
            "Content-Type": "application/json"
        }

    def get_specific_20minutos_article(self) -> tuple:
        """20minutosì—ì„œ êµ¬ì²´ì ì¸ ê¸°ì‚¬ ë§í¬ì™€ ì œëª© ì¶”ì¶œ"""
        try:
            # RSS í”¼ë“œì—ì„œ ìµœì‹  ê¸°ì‚¬ë“¤ ê°€ì ¸ì˜¤ê¸°
            rss_url = "https://www.20minutos.es/rss/"
            feed = feedparser.parse(rss_url)
            
            if feed.entries:
                # ê°€ì¥ ìµœì‹  ê¸°ì‚¬ ì„ íƒ
                latest_article = feed.entries[0]
                
                # ê¸°ì‚¬ ë‚´ìš© ë¯¸ë¦¬ë³´ê¸°ë¡œ ì–´íœ˜ ì˜ˆì¸¡
                summary = latest_article.get('summary', '')
                category = self.extract_category_from_summary(summary)
                
                return {
                    'title': latest_article.title,
                    'url': latest_article.link,
                    'published': latest_article.get('published', ''),
                    'category': category,
                    'preview': summary[:200] + '...' if len(summary) > 200 else summary
                }
        except Exception as e:
            print(f"20minutos ê¸°ì‚¬ ì¶”ì¶œ ì˜¤ë¥˜: {e}")
            return None

    def extract_category_from_summary(self, summary: str) -> str:
        """ê¸°ì‚¬ ìš”ì•½ì—ì„œ ì¹´í…Œê³ ë¦¬ ì¶”ì¶œ"""
        keywords = {
            'ì •ì¹˜': ['gobierno', 'polÃ­tica', 'elecciones', 'parlamento', 'ministro'],
            'ê²½ì œ': ['economÃ­a', 'banco', 'euro', 'empleo', 'crisis', 'mercado'],
            'ì‚¬íšŒ': ['sociedad', 'educaciÃ³n', 'sanidad', 'vivienda', 'familia'],
            'ìŠ¤í¬ì¸ ': ['fÃºtbol', 'Real Madrid', 'Barcelona', 'Liga', 'deporte'],
            'ê¸°ìˆ ': ['tecnologÃ­a', 'internet', 'mÃ³vil', 'digital', 'app']
        }
        
        summary_lower = summary.lower()
        for category, words in keywords.items():
            if any(word in summary_lower for word in words):
                return category
        return 'ì¼ë°˜'

    def get_specific_podcast_episode(self, podcast_type: str) -> dict:
        """íŠ¹ì • íŒŸìºìŠ¤íŠ¸ì˜ ìµœì‹  ì—í”¼ì†Œë“œ ì •ë³´ ì¶”ì¶œ"""
        
        if podcast_type == "hoy_hablamos":
            return self.get_hoy_hablamos_episode()
        elif podcast_type == "radio_ambulante":
            return self.get_radio_ambulante_episode()
        elif podcast_type == "advanced_spanish":
            return self.get_advanced_spanish_episode()
        elif podcast_type == "dele_podcast":
            return self.get_dele_podcast_episode()
        
        return None

    def get_hoy_hablamos_episode(self) -> dict:
        """Hoy Hablamos ìµœì‹  ì—í”¼ì†Œë“œ"""
        try:
            # RSS í”¼ë“œ ë˜ëŠ” ì›¹ì‚¬ì´íŠ¸ ìŠ¤í¬ë˜í•‘
            rss_url = "https://feeds.feedburner.com/hoyhablamos"
            feed = feedparser.parse(rss_url)
            
            if feed.entries:
                latest = feed.entries[0]
                episode_number = self.extract_episode_number(latest.title)
                
                return {
                    'title': f"Hoy Hablamos Ep.{episode_number}: {latest.title}",
                    'url': latest.link,
                    'duration': self.extract_duration(latest.get('summary', '')),
                    'topic': self.extract_topic_keywords(latest.title),
                    'published': latest.get('published', ''),
                    'direct_play_url': self.get_direct_audio_url(latest.link)
                }
        except Exception as e:
            print(f"Hoy Hablamos ì—í”¼ì†Œë“œ ì¶”ì¶œ ì˜¤ë¥˜: {e}")
            # í´ë°±: ì¼ë°˜ì ì¸ ì •ë³´ ì œê³µ
            return {
                'title': "Hoy Hablamos - ìµœì‹  ì¼ì¼ ì—í”¼ì†Œë“œ",
                'url': "https://www.hoyhablamos.com/",
                'topic': "ìŠ¤í˜ì¸ ì¼ìƒ ì£¼ì œ",
                'instruction': "ì›¹ì‚¬ì´íŠ¸ì—ì„œ ê°€ì¥ ìµœì‹  ì—í”¼ì†Œë“œë¥¼ ì„ íƒí•˜ì„¸ìš”"
            }

    def get_radio_ambulante_episode(self) -> dict:
        """Radio Ambulante ìµœì‹  ì—í”¼ì†Œë“œ"""
        try:
            # NPR RSS í”¼ë“œ ì‚¬ìš©
            rss_url = "https://feeds.npr.org/510311/podcast.xml"
            feed = feedparser.parse(rss_url)
            
            if feed.entries:
                latest = feed.entries[0]
                
                return {
                    'title': f"Radio Ambulante: {latest.title}",
                    'url': latest.link,
                    'duration': self.extract_duration_from_itunes(latest),
                    'country': self.extract_country_from_title(latest.title),
                    'published': latest.get('published', ''),
                    'apple_url': f"https://podcasts.apple.com/podcast/radio-ambulante/id527614348?i={self.extract_episode_id(latest.link)}"
                }
        except Exception as e:
            print(f"Radio Ambulante ì—í”¼ì†Œë“œ ì¶”ì¶œ ì˜¤ë¥˜: {e}")
            return {
                'title': "Radio Ambulante - ìµœì‹  ë¼í‹´ì•„ë©”ë¦¬ì¹´ ìŠ¤í† ë¦¬",
                'url': "https://radioambulante.org/",
                'instruction': "Apple Podcastsì—ì„œ ê°€ì¥ ìµœì‹  ì—í”¼ì†Œë“œë¥¼ ì„ íƒí•˜ì„¸ìš”"
            }

    def get_advanced_spanish_episode(self) -> dict:
        """Advanced Spanish Podcast ìµœì‹  ì—í”¼ì†Œë“œ"""
        try:
            # Spanish Language Coach ì›¹ì‚¬ì´íŠ¸ ìŠ¤í¬ë˜í•‘
            url = "https://www.spanishlanguagecoach.com/podcast/"
            response = requests.get(url)
            soup = BeautifulSoup(response.content, 'html.parser')
            
            # ìµœì‹  ì—í”¼ì†Œë“œ ì°¾ê¸°
            latest_episode = soup.find('article', class_='post')
            if latest_episode:
                title = latest_episode.find('h2').text.strip()
                episode_url = latest_episode.find('a')['href']
                
                return {
                    'title': f"Advanced Spanish: {title}",
                    'url': episode_url,
                    'level': 'C1',
                    'has_transcript': True,
                    'has_flashcards': True,
                    'apple_url': "https://podcasts.apple.com/kr/podcast/advanced-spanish-podcast-espaÃ±ol-avanzado/id1632291264"
                }
        except Exception as e:
            print(f"Advanced Spanish ì—í”¼ì†Œë“œ ì¶”ì¶œ ì˜¤ë¥˜: {e}")
            return {
                'title': "Advanced Spanish - ìµœì‹  ê³ ê¸‰ ëŒ€í™”",
                'url': "https://www.spanishlanguagecoach.com/podcast/",
                'instruction': "ì›¹ì‚¬ì´íŠ¸ì—ì„œ ìµœì‹  ì—í”¼ì†Œë“œë¥¼ í™•ì¸í•˜ì„¸ìš”"
            }

    def extract_episode_number(self, title: str) -> str:
        """ì œëª©ì—ì„œ ì—í”¼ì†Œë“œ ë²ˆí˜¸ ì¶”ì¶œ"""
        match = re.search(r'(\d+)', title)
        return match.group(1) if match else 'Latest'

    def extract_duration(self, summary: str) -> str:
        """ìš”ì•½ì—ì„œ ì¬ìƒì‹œê°„ ì¶”ì¶œ"""
        duration_match = re.search(r'(\d+)\s*min', summary)
        return f"{duration_match.group(1)}ë¶„" if duration_match else "ì•½ 15-25ë¶„"

    def extract_topic_keywords(self, title: str) -> str:
        """ì œëª©ì—ì„œ ì£¼ì œ í‚¤ì›Œë“œ ì¶”ì¶œ"""
        # ì¼ë°˜ì ì¸ ì£¼ì œ í‚¤ì›Œë“œ ë§¤í•‘
        topic_map = {
            'gramÃ¡tica': 'ë¬¸ë²•',
            'cultura': 'ë¬¸í™”', 
            'historia': 'ì—­ì‚¬',
            'cocina': 'ìš”ë¦¬',
            'viajes': 'ì—¬í–‰',
            'trabajo': 'ì§ì—…',
            'familia': 'ê°€ì¡±',
            'tecnologÃ­a': 'ê¸°ìˆ '
        }
        
        title_lower = title.lower()
        for spanish, korean in topic_map.items():
            if spanish in title_lower:
                return korean
        return 'ì¼ë°˜ ì£¼ì œ'

    def create_detailed_memo(self, content_type: str, data: dict) -> str:
        """ìƒì„¸í•œ ë©”ëª¨ ìƒì„±"""
        if content_type == "article":
            return f"""ğŸ“° {data.get('category', 'ì¼ë°˜')} ë¶„ì•¼ ê¸°ì‚¬
ğŸ“… ë°œí–‰: {data.get('published', 'ì˜¤ëŠ˜')}
ğŸ¯ í•™ìŠµëª©í‘œ: 15ë¶„ ë…í•´, ì–´íœ˜ 5ê°œ ì •ë¦¬
ğŸ’¡ ë¯¸ë¦¬ë³´ê¸°: {data.get('preview', '')}
ğŸ“ ê¶Œì¥: ëª¨ë¥´ëŠ” ë‹¨ì–´ëŠ” ë…¸íŠ¸ì— ì •ë¦¬í•˜ë©° ì½ê¸°"""

        elif content_type == "podcast":
            return f"""ğŸ§ {data.get('title', '')}
â±ï¸ ì¬ìƒì‹œê°„: {data.get('duration', '15-25ë¶„')}
ğŸ¯ í•™ìŠµëª©í‘œ: 25ë¶„ ì²­ì·¨, í‘œí˜„ 5ê°œ ì •ë¦¬
ğŸŒ ì§€ì—­: {data.get('country', 'ìŠ¤í˜ì¸/ì¤‘ë‚¨ë¯¸')}
ğŸ“ ê¶Œì¥: {data.get('instruction', 'ì „ì‚¬ë³¸ í™œìš©í•˜ì—¬ ë°˜ë³µ ì²­ì·¨')}"""

    def add_to_notion_with_specific_links(self, article_data: dict, podcast_data: dict):
        """êµ¬ì²´ì ì¸ ë§í¬ì™€ í•¨ê»˜ Notion DB ì—…ë°ì´íŠ¸"""
        today = datetime.now().strftime("%Y-%m-%d")
        
        # ë…í•´ ìë£Œ ì¶”ê°€ (ì‹¤ì œ ê¸°ì‚¬ ë§í¬)
        if article_data:
            reading_payload = {
                "parent": {"database_id": self.database_id},
                "properties": {
                    "ë‚´ìš©": {"title": [{"text": {"content": f"[{today}] {article_data['title']}"}}]},
                    "URL": {"url": article_data['url']},  # ì‹¤ì œ ê¸°ì‚¬ ë§í¬
                    "ë‚ ì§œ": {"date": {"start": today}},
                    "ì§€ì—­": {"select": {"name": "ìŠ¤í˜ì¸"}},
                    "ë‚œì´ë„": {"select": {"name": "B2"}},
                    "ìë£Œ ìœ í˜•": {"select": {"name": "ê¸°ì‚¬/ë‰´ìŠ¤"}},
                    "í•™ìŠµ ì˜ì—­": {"select": {"name": "ë…í•´"}},
                    "ë©”ëª¨": {"rich_text": [{"text": {"content": self.create_detailed_memo("article", article_data)}}]}
                }
            }
            
            self.send_to_notion(reading_payload, "ë…í•´ ìë£Œ")

        # ì²­í•´ ìë£Œ ì¶”ê°€ (êµ¬ì²´ì ì¸ ì—í”¼ì†Œë“œ ë§í¬)
        if podcast_data:
            podcast_payload = {
                "parent": {"database_id": self.database_id},
                "properties": {
                    "ë‚´ìš©": {"title": [{"text": {"content": f"[{today}] {podcast_data['title']}"}}]},
                    "URL": {"url": podcast_data.get('apple_url', podcast_data['url'])},  # Apple Podcasts ì§ì ‘ ë§í¬ ìš°ì„ 
                    "ë‚ ì§œ": {"date": {"start": today}},
                    "ì§€ì—­": {"select": {"name": podcast_data.get('region', 'ìŠ¤í˜ì¸')}},
                    "ë‚œì´ë„": {"select": {"name": "C1"}},
                    "ìë£Œ ìœ í˜•": {"select": {"name": "íŒŸìºìŠ¤íŠ¸"}},
                    "í•™ìŠµ ì˜ì—­": {"select": {"name": "ì²­í•´"}},
                    "ë©”ëª¨": {"rich_text": [{"text": {"content": self.create_detailed_memo("podcast", podcast_data)}}]}
                }
            }
            
            self.send_to_notion(podcast_payload, "ì²­í•´ ìë£Œ")

    def send_to_notion(self, payload: dict, content_type: str):
        """Notion API ì „ì†¡"""
        try:
            response = requests.post(
                "https://api.notion.com/v1/pages",
                headers=self.headers,
                json=payload
            )
            if response.status_code == 200:
                print(f"âœ… {content_type} ì¶”ê°€ ì„±ê³µ!")
            else:
                print(f"âŒ {content_type} ì¶”ê°€ ì‹¤íŒ¨: {response.text}")
        except Exception as e:
            print(f"{content_type} ì „ì†¡ ì˜¤ë¥˜: {e}")

# ì‹¤í–‰ ì˜ˆì‹œ
def main():
    automation = ImprovedSpanishAutomation()
    
    # ì‹¤ì œ ê¸°ì‚¬ì™€ ì—í”¼ì†Œë“œ ìˆ˜ì§‘
    article_data = automation.get_specific_20minutos_article()
    podcast_data = automation.get_specific_podcast_episode("hoy_hablamos")  # ì›”ìš”ì¼
    
    # Notion DBì— êµ¬ì²´ì ì¸ ë§í¬ì™€ í•¨ê»˜ ì¶”ê°€
    automation.add_to_notion_with_specific_links(article_data, podcast_data)

if __name__ == "__main__":
    main()