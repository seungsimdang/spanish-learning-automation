# .github/workflows/spanish-learning-automation.yml
name: ìŠ¤í˜ì¸ì–´ í•™ìŠµ ìë£Œ ìë™ ìˆ˜ì§‘

on:
  schedule:
    # ë§¤ì¼ UTC 23:00 (í•œêµ­ì‹œê°„ ì˜¤ì „ 8ì‹œ)ì— ì‹¤í–‰
    - cron: "0 23 * * 1-5" # í‰ì¼ë§Œ ì‹¤í–‰
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

env:
  NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
  NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}

jobs:
  collect-learning-materials:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install requests beautifulsoup4 feedparser python-dateutil

      - name: Calculate learning phase
        id: phase
        run: |
          # í˜„ì¬ ë‚ ì§œ ê¸°ì¤€ìœ¼ë¡œ í•™ìŠµ ë‹¨ê³„ ê³„ì‚°
          python3 << 'EOF'
          import os
          from datetime import datetime, timedelta

          # í•™ìŠµ ì‹œì‘ì¼ (2025-07-01)
          start_date = datetime(2025, 7, 1)
          current_date = datetime.now()

          # ì£¼ì°¨ ê³„ì‚°
          week_num = (current_date - start_date).days // 7 + 1
          weekday = current_date.weekday()  # 0=ì›”ìš”ì¼

          # ë…í•´ ì†ŒìŠ¤ ê²°ì •
          if week_num <= 2:
              reading_source = "20minutos"
              reading_url = "https://www.20minutos.es/"
              reading_difficulty = "B2"
          elif week_num <= 4:
              reading_source = "El PaÃ­s ë‹¨ì‹ "
              reading_url = "https://elpais.com/"
              reading_difficulty = "B2"
          else:
              reading_source = "El PaÃ­s ì‚¬ì„¤"
              reading_url = "https://elpais.com/opinion/"
              reading_difficulty = "C1"
              
          # íŒŸìºìŠ¤íŠ¸ ì¼ì •
          podcast_schedule = {
              0: ("Hoy Hablamos", "https://podcasts.apple.com/kr/podcast/hoy-hablamos-podcast-diario-para-aprender-espaÃ±ol-learn/id1201483158", "ìŠ¤í˜ì¸"),
              1: ("Radio Ambulante", "https://podcasts.apple.com/kr/podcast/radio-ambulante/id527614348", "ì¤‘ë‚¨ë¯¸"),
              2: ("Advanced Spanish", "https://podcasts.apple.com/kr/podcast/advanced-spanish-podcast-espaÃ±ol-avanzado/id1632291264", "ìŠ¤í˜ì¸"),
              3: ("Radio Ambulante", "https://podcasts.apple.com/kr/podcast/radio-ambulante/id527614348", "ì¤‘ë‚¨ë¯¸"),
              4: ("DELE Podcast", "https://podcasts.apple.com/us/podcast/examen-dele/id1705001626", "ìŠ¤í˜ì¸")
          }

          podcast_name, podcast_url, podcast_region = podcast_schedule.get(weekday, ("Hoy Hablamos", "https://podcasts.apple.com/kr/podcast/hoy-hablamos-podcast-diario-para-aprender-espaÃ±ol-learn/id1201483158", "ìŠ¤í˜ì¸"))

          # GitHub Actions í™˜ê²½ë³€ìˆ˜ë¡œ ì¶œë ¥
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"week_num={week_num}\n")
              f.write(f"reading_source={reading_source}\n")
              f.write(f"reading_url={reading_url}\n")
              f.write(f"reading_difficulty={reading_difficulty}\n")
              f.write(f"podcast_name={podcast_name}\n")
              f.write(f"podcast_url={podcast_url}\n")
              f.write(f"podcast_region={podcast_region}\n")
              f.write(f"date={current_date.strftime('%Y-%m-%d')}\n")
          EOF

      - name: Collect latest articles
        id: articles
        run: |
          python3 << 'EOF'
          import os
          import requests
          import feedparser
          from datetime import datetime

          # RSS í”¼ë“œì—ì„œ ìµœì‹  ê¸°ì‚¬ ìˆ˜ì§‘
          def get_latest_article(source):
              try:
                  if source == "20minutos":
                      feed_url = "https://www.20minutos.es/rss/"
                  elif "El PaÃ­s" in source:
                      feed_url = "https://feeds.elpais.com/mrss-s/pages/ep/site/elpais.com/portada"
                  else:
                      return None, None
                      
                  feed = feedparser.parse(feed_url)
                  if feed.entries:
                      latest = feed.entries[0]
                      return latest.title, latest.link
                  return None, None
              except Exception as e:
                  print(f"Error fetching {source}: {e}")
                  return None, None

          reading_source = "${{ steps.phase.outputs.reading_source }}"
          title, url = get_latest_article(reading_source)

          if title and url:
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write(f"article_title={title}\n")
                  f.write(f"article_url={url}\n")
          EOF

      - name: Add materials to Notion
        run: |
          python3 << 'EOF'
          import os
          import requests
          import json
          from datetime import datetime

          notion_token = os.environ['NOTION_TOKEN']
          database_id = os.environ['NOTION_DATABASE_ID']

          headers = {
              "Authorization": f"Bearer {notion_token}",
              "Notion-Version": "2022-06-28", 
              "Content-Type": "application/json"
          }

          today = "${{ steps.phase.outputs.date }}"

          # ë…í•´ ìë£Œ ì¶”ê°€
          reading_title = "${{ steps.articles.outputs.article_title }}" or f"[${{ steps.phase.outputs.reading_source }}] ìµœì‹  ê¸°ì‚¬"
          reading_url = "${{ steps.articles.outputs.article_url }}" or "${{ steps.phase.outputs.reading_url }}"

          reading_payload = {
              "parent": {"database_id": database_id},
              "properties": {
                  "ë‚´ìš©": {"title": [{"text": {"content": f"[{today}] {reading_title}"}}]},
                  "URL": {"url": reading_url},
                  "ë‚ ì§œ": {"date": {"start": today}},
                  "ì§€ì—­": {"select": {"name": "ìŠ¤í˜ì¸"}},
                  "ë‚œì´ë„": {"select": {"name": "${{ steps.phase.outputs.reading_difficulty }}"}},
                  "ìë£Œ ìœ í˜•": {"select": {"name": "ê¸°ì‚¬/ë‰´ìŠ¤"}},
                  "í•™ìŠµ ì˜ì—­": {"select": {"name": "ë…í•´"}},
                  "ë©”ëª¨": {"rich_text": [{"text": {"content": "15ë¶„ ë…í•´ ì—°ìŠµ. ì–´íœ˜ 5ê°œ ì •ë¦¬ ëª©í‘œ."}}]}
              }
          }

          # ì²­í•´ ìë£Œ ì¶”ê°€
          podcast_payload = {
              "parent": {"database_id": database_id},
              "properties": {
                  "ë‚´ìš©": {"title": [{"text": {"content": f"[{today}] ${{ steps.phase.outputs.podcast_name }}"}}]},
                  "URL": {"url": "${{ steps.phase.outputs.podcast_url }}"},
                  "ë‚ ì§œ": {"date": {"start": today}},
                  "ì§€ì—­": {"select": {"name": "${{ steps.phase.outputs.podcast_region }}"}},
                  "ë‚œì´ë„": {"select": {"name": "C1"}},
                  "ìë£Œ ìœ í˜•": {"select": {"name": "íŒŸìºìŠ¤íŠ¸"}},
                  "í•™ìŠµ ì˜ì—­": {"select": {"name": "ì²­í•´"}},
                  "ë©”ëª¨": {"rich_text": [{"text": {"content": "25ë¶„ ì²­ì·¨ ëª©í‘œ. í‘œí˜„ 5ê°œ ì •ë¦¬."}}]}
              }
          }

          # Notion API í˜¸ì¶œ
          try:
              # ë…í•´ ìë£Œ ì¶”ê°€
              response = requests.post(
                  "https://api.notion.com/v1/pages",
                  headers=headers,
                  json=reading_payload
              )
              if response.status_code == 200:
                  print(f"âœ… ë…í•´ ìë£Œ ì¶”ê°€ ì„±ê³µ: {reading_title}")
              else:
                  print(f"âŒ ë…í•´ ìë£Œ ì¶”ê°€ ì‹¤íŒ¨: {response.text}")
                  
              # ì²­í•´ ìë£Œ ì¶”ê°€  
              response = requests.post(
                  "https://api.notion.com/v1/pages",
                  headers=headers,
                  json=podcast_payload
              )
              if response.status_code == 200:
                  print(f"âœ… ì²­í•´ ìë£Œ ì¶”ê°€ ì„±ê³µ: ${{ steps.phase.outputs.podcast_name }}")
              else:
                  print(f"âŒ ì²­í•´ ìë£Œ ì¶”ê°€ ì‹¤íŒ¨: {response.text}")
                  
          except Exception as e:
              print(f"ì˜¤ë¥˜ ë°œìƒ: {e}")
          EOF

      - name: Send notification
        if: success()
        run: |
          echo "ğŸ‰ ${{ steps.phase.outputs.date }} ìŠ¤í˜ì¸ì–´ í•™ìŠµ ìë£Œ ìë™ ìˆ˜ì§‘ ì™„ë£Œ!"
          echo "ğŸ“– ë…í•´: ${{ steps.phase.outputs.reading_source }}"
          echo "ğŸ§ ì²­í•´: ${{ steps.phase.outputs.podcast_name }}"
          echo "ğŸ“… í•™ìŠµ ì£¼ì°¨: ${{ steps.phase.outputs.week_num }}ì£¼ì°¨"
